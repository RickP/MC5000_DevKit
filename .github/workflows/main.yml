name: Build_App

on:
  push:
    tags:
      - v*

jobs:
  build_linux:
    runs-on: ubuntu-18.04
    steps:

      - uses: actions/checkout@v2

      - name: Install Qt
        uses: jurplel/install-qt-action@v2.12.2
        
      - name: Install dependencies
        run: |
          sudo apt-get install -y libxcb* patchelf libgl1-mesa-dev
          cd gui
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod 755 linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod 755 linuxdeploy-plugin-qt-x86_64.AppImage
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod 755 appimagetool-x86_64.AppImage
        shell: bash

      - name: compile
        run: |
          cd gui
          qmake
          make
        shell: bash
        
      - name: package 
        run: |
          cd gui
          QML_SOURCES_PATHS=. ./linuxdeploy-x86_64.AppImage --plugin qt --appdir AppDir -d imagebuilder/MC5000.desktop -e MC5000-GUI -i icons/icon.png
          ./appimagetool-x86_64.AppImage AppDir
          mv MC5000-GUI-x86_64.AppImage MC5000-GUI_Linux_x86_64.AppImage

        shell: bash

      - name: release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: '${{ secrets.GITHUB_TOKEN }}'
          automatic_release_tag: "latest_linux"
          title: "Linux Desktop App"
          files: |
            gui/MC5000-GUI_Linux_x86_64.AppImage

  build_windows:
    runs-on: windows-2019
    steps:

      - uses: actions/checkout@v2

      - name: Install Qt
        uses: jurplel/install-qt-action@v2.12.2
        with:
          arch: win64_mingw81

      - name: compile
        run: |
          call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cd gui
          qmake
          make
          windeployqt --qmldir . release/MC5000-GUI.exe
          rename release MC5000-GUI
        shell: cmd

      - name: pack
        uses: papeloto/action-zip@v1
        with:
          files: gui/MC5000-GUI/
          dest: MC5000-GUI_Windows_x86_64.zip

      - name: release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: '${{ secrets.GITHUB_TOKEN }}'
          automatic_release_tag: "latest_windows"
          title: "Windows Desktop App"
          files: |
            MC5000-GUI_Windows_x86_64.zip